// Generated by CoffeeScript 1.7.1
(function() {
  var Async, Db, ErrorHandler, Express, Moment, MongoDb, Morgan, app, _ipAddress, _port, _ref, _ref1;

  Express = require('express');

  MongoDb = require('mongodb');

  Async = require('async');

  Morgan = require('morgan');

  ErrorHandler = require('errorhandler');

  Moment = require('moment');

  Db = require('./db');

  _ipAddress = (_ref = process.env.OPENSHIFT_NODEJS_IP) != null ? _ref : '127.0.0.1';

  _port = (_ref1 = process.env.OPENSHIFT_NODEJS_PORT) != null ? _ref1 : 8080;

  app = Express();

  app.set('view engine', 'pug');

  app.use(Morgan('combined'));

  app.use(ErrorHandler());

  app.get('/', function(req, res) {
    var selector;
    selector = {};
    return Db.collections.lengths.find(selector).sort({
      date: 1
    }).toArray(function(err, lengths) {
      var mappedLengths;
      if (err != null) {
        return res.status(500).send(err);
      }
      mappedLengths = lengths.map(function(length) {
        length.formatDate = Moment(length.date).format('ddd D MMMM YYYY');
        if (lengths.Footnotes != null) {
          lengths.formatFootnotes = lengths.Footnotes.replace('\n', '<br>');
        }
        return length;
      });
      return res.render('index', {
        performances: lengths
      });
    });
  });

  Db.start(function(err) {
    if (err != null) {
      throw new Error("DB start failed: " + err);
    }
    return app.listen(_port, _ipAddress, function() {
      return console.log("Web server started");
    });
  });

}).call(this);
